name: Frontend Release

on:
  push:
    branches:
      - main

jobs:
  release:
    name: Deploy frontend on [release] commit
    runs-on: ubuntu-latest

    steps:
      - name: Check if commit message starts with [release]
      id: check
      run: |
        set -e
        MSG="${{ github.event.head_commit.message }}"
        echo "Commit message: $MSG"
        if [[ "$MSG" == \[release\]* ]]; then
          echo "should_deploy=true" >> "$GITHUB_OUTPUT"
        else
          echo "should_deploy=false" >> "$GITHUB_OUTPUT"
        fi

      - name: Deploy via SSH (runs release script on droplet)
        if: steps.check.outputs.should_deploy == 'true'
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.DO_HOST }}
          username: ${{ secrets.DO_USERNAME }}
          key: ${{ secrets.DO_SSH_KEY }}
          port: ${{ secrets.DO_PORT }}
          script_stop: true
          script: |
            set -e
            COMMIT_SHA="${{ github.sha }}"
            # Preserve multiline commit messages safely
            COMMIT_MSG=$(cat <<'EOF'
            ${{ github.event.head_commit.message }}
            EOF
            )
            export COMMIT_SHA
            export COMMIT_MSG

            bash /opt/lol-tracker/lol-tracker-gordos-frontend/frontend-release.sh
