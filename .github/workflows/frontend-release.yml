name: Frontend Release

on:
  push:
    branches: ["main"]
  workflow_dispatch: {}

permissions:
  contents: read

jobs:
  release:
    name: Release / Deploy
    runs-on: ubuntu-latest

    steps:
      - name: Debug — print trigger context
        shell: bash
        run: |
          echo "event_name=${{ github.event_name }}"
          echo "ref=${{ github.ref }}"
          echo "sha=${{ github.sha }}"
          echo "head_commit_message=${{ github.event.head_commit.message }}"

      - name: Decide if this is a [release] commit
        id: gate
        shell: bash
        run: |
          set -e
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "should_deploy=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          MSG="${{ github.event.head_commit.message }}"
          if [[ "$MSG" == \[release\]* ]]; then
            echo "should_deploy=true" >> "$GITHUB_OUTPUT"
          else
            echo "should_deploy=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Deploy via SSH (runs release script on droplet)
        if: steps.gate.outputs.should_deploy == 'true'
        uses: appleboy/ssh-action@v1.2.0
        env:
          COMMIT_SHA: ${{ github.sha }}
          COMMIT_MSG: ${{ github.event.head_commit.message }}
        with:
          host: ${{ secrets.DROPLET_HOST }}
          username: ${{ secrets.DROPLET_USER }}
          key: ${{ secrets.DROPLET_SSH_KEY }}
          port: ${{ secrets.DROPLET_PORT }}
          envs: COMMIT_SHA,COMMIT_MSG
          script_stop: true
          script: |
            set -euo pipefail

            # COMMIT_SHA and COMMIT_MSG arrive as env vars.
            # Encode COMMIT_MSG safely to avoid any shell parsing issues.
            export COMMIT_SHA="${COMMIT_SHA:-${{ github.sha }}}"
            export COMMIT_MSG="${COMMIT_MSG:-}"
            export COMMIT_MSG_B64="$(printf "%s" "${COMMIT_MSG}" | base64 -w0)"

            # Decode back into COMMIT_MSG on the droplet
            export COMMIT_MSG="$(printf "%s" "${COMMIT_MSG_B64}" | base64 -d)"

            echo "remote_user=$(id -un) home=${HOME:-} shell=${SHELL:-}"
            bash /opt/lol-tracker/lol-tracker-gordos-frontend/frontend-release.sh

      - name: Skipped (not a [release] commit)
        if: steps.gate.outputs.should_deploy != 'true'
        run: echo "Not a [release] commit — deploy skipped."
