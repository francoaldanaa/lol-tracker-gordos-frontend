name: Frontend Release

on:
  push:
    branches: ["main"]
  workflow_dispatch: {}

permissions:
  contents: read

jobs:
  release:
    name: Release / Deploy
    runs-on: ubuntu-latest

    steps:
      - name: Debug — print trigger context
        shell: bash
        run: |
          echo "event_name=${{ github.event_name }}"
          echo "ref=${{ github.ref }}"
          echo "sha=${{ github.sha }}"
          echo "head_commit_message=${{ github.event.head_commit.message }}"

      - name: Decide if this is a [release] commit
        id: gate
        shell: bash
        run: |
          set -e
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "should_deploy=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          MSG="${{ github.event.head_commit.message }}"
          if [[ "$MSG" == \[release\]* ]]; then
            echo "should_deploy=true" >> "$GITHUB_OUTPUT"
          else
            echo "should_deploy=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Deploy via SSH (runs release script on droplet)
        if: steps.gate.outputs.should_deploy == 'true'
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.DO_HOST }}
          username: ${{ secrets.DO_USERNAME }}
          key: ${{ secrets.DO_SSH_KEY }}
          port: ${{ secrets.DO_PORT }}
          script_stop: true
          script: |
            set -e
            COMMIT_SHA="${{ github.sha }}"
            COMMIT_MSG=$(cat <<'EOF'
            ${{ github.event.head_commit.message }}
            EOF
            )
            export COMMIT_SHA
            export COMMIT_MSG
            bash /opt/lol-tracker/lol-tracker-gordos-frontend/frontend-release.sh

      - name: Skipped (not a [release] commit)
        if: steps.gate.outputs.should_deploy != 'true'
        run: echo "Not a [release] commit — deploy skipped."
